<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sentiment Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="text-center text-primary mb-4">Sentiment Dashboard</h2>
    <p class="text-center text-muted">Upload the processed CSV (with <code>Discussion Topic</code> and <code>label</code> columns) to view sentiment distribution per topic.</p>
    
    <div class="card p-4 shadow rounded-4">
      <input type="file" id="csvFile" accept=".csv" class="form-control mb-3">
      <button class="btn btn-primary" onclick="loadCSV()">Upload & Visualize</button>
    </div>

    <div id="charts" class="row mt-4 g-4"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    function loadCSV() {
      const file = document.getElementById("csvFile").files[0];
      if (!file) {
        alert("Please select a CSV file first.");
        return;
      }

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;
          renderDashboard(data);
        }
      });
    }

    function renderDashboard(data) {
      const grouped = {};

      // Normalize and group counts by topic and label
      data.forEach(row => {
        let topic = row["Discussion Topic"];
        const label = (row["label"] || "").trim().toUpperCase();

        if (topic) {
          topic = topic.trim().replace(/\s+/g, " "); // normalize whitespace
        }

        if (!grouped[topic]) {
          grouped[topic] = { SUPPORT: 0, CRITICIZE: 0, NEUTRAL: 0 };
        }
        if (grouped[topic][label] !== undefined) {
          grouped[topic][label]++;
        }
      });

      // Clear old charts
      document.getElementById("charts").innerHTML = "";

      // Create dashboard for each topic
      Object.keys(grouped).forEach(topic => {
        const counts = grouped[topic];
        const total = counts.SUPPORT + counts.CRITICIZE + counts.NEUTRAL;

        if (total === 0) return;

        // Percentages
        const supportPct = ((counts.SUPPORT / total) * 100).toFixed(1);
        const criticizePct = ((counts.CRITICIZE / total) * 100).toFixed(1);
        const neutralPct = ((counts.NEUTRAL / total) * 100).toFixed(1);

        const chartId = "chart_" + topic.replace(/\W+/g, "_");

        const chartContainer = document.createElement("div");
        chartContainer.className = "col-md-6";
        chartContainer.innerHTML = `
          <div class="card p-3 shadow-sm rounded-4">
            <h5 class="text-center mb-3">${topic}</h5>

            <!-- Metrics -->
            <div class="row text-center mb-3">
              <div class="col">
                <h6 class="text-success">Support</h6>
                <p><b>${counts.SUPPORT}</b> (${supportPct}%)</p>
              </div>
              <div class="col">
                <h6 class="text-danger">Criticize</h6>
                <p><b>${counts.CRITICIZE}</b> (${criticizePct}%)</p>
              </div>
              <div class="col">
                <h6 class="text-warning">Neutral</h6>
                <p><b>${counts.NEUTRAL}</b> (${neutralPct}%)</p>
              </div>
            </div>

            <!-- Chart -->
            <canvas id="${chartId}" height="200"></canvas>
          </div>
        `;
        document.getElementById("charts").appendChild(chartContainer);

        // Pie Chart
        new Chart(document.getElementById(chartId), {
          type: "doughnut",
          data: {
            labels: ["Support", "Criticize", "Neutral"],
            datasets: [{
              data: [counts.SUPPORT, counts.CRITICIZE, counts.NEUTRAL],
              backgroundColor: ["#28a745", "#dc3545", "#ffc107"]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "bottom" },
              tooltip: { callbacks: { label: ctx => ctx.label + ": " + ctx.raw + " (" + (ctx.raw/total*100).toFixed(1) + "%)" } }
            }
          }
        });
      });
    }
  </script>
</body>
</html>
